<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Login Demo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <div id="app" v-cloak class="w-full max-w-md p-4">

        <!-- Loading State -->
        <div v-if="loading" class="bg-white rounded-lg shadow-lg p-8 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-600">{{ statusMessage }}</p>
            <!-- Debug Log -->
            <div v-if="logs.length > 0"
                class="mt-4 w-full bg-gray-100 p-2 rounded text-xs text-gray-500 font-mono h-24 overflow-y-auto">
                <div v-for="(log, i) in logs" :key="i">> {{ log }}</div>
            </div>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="bg-white rounded-lg shadow-lg p-8 text-center">
            <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">ç™¼ç”ŸéŒ¯èª¤</h2>
            <p class="text-gray-600 mb-6">{{ errorMessage }}</p>
            <button @click="retry" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                é‡è©¦
            </button>
            <div class="mt-4 text-left bg-gray-900 text-green-400 p-2 rounded text-xs font-mono overflow-x-auto">
                {{ errorMessage }}
            </div>
        </div>

        <!-- Success State (Profile) -->
        <div v-else-if="user" class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Header Background -->
            <div class="bg-green-500 h-24"></div>

            <!-- Avatar -->
            <div class="px-6 relative">
                <img :src="user.pictureUrl || 'https://via.placeholder.com/150'"
                    class="w-24 h-24 rounded-full border-4 border-white absolute -top-12 shadow-md bg-white block">
            </div>

            <!-- Content -->
            <div class="mt-16 px-6 pb-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800">{{ user.displayName }}</h2>
                <p class="text-sm text-gray-500 mb-4">{{ user.userId }}</p>

                <!--  Debug Box (Explicitly shown) -->
                <div class="bg-black text-white p-3 rounded mb-4 text-left text-xs font-mono">
                    <p class="text-green-400 font-bold mb-1">=== DEBUG INFO ===</p>
                    <p>Role: <span class="text-yellow-300">"{{ user.role }}"</span></p>
                    <p>Status: <span class="text-yellow-300">"{{ user.accountStatus }}"</span></p>
                    <p>Friend: <span class="text-yellow-300">{{ user.isFriend }}</span></p>
                </div>

                <!-- Role Badge -->
                <div class="flex justify-center flex-wrap gap-2 mb-6">
                    <!-- Admin -->
                    <span v-if="user.role === 'admin'"
                        class="px-3 py-1 rounded-full text-sm font-bold bg-purple-100 text-purple-800 border border-purple-200">
                        ğŸ‘‘ ç®¡ç†å“¡
                    </span>
                    <!-- User -->
                    <span v-else-if="user.role === 'user'"
                        class="px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800 border border-blue-200">
                        ğŸ‘¤ ä½¿ç”¨è€…
                    </span>
                    <!-- Guest (Default) -->
                    <span v-else
                        class="px-3 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-800 border border-gray-200">
                        ğŸ‘ï¸ è¨ªå®¢ ({{ user.role || 'none' }})
                    </span>

                    <!-- Pending Status -->
                    <span v-if="user.accountStatus === 'pending'"
                        class="px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                        â³ å¾…å¯©æ ¸
                    </span>
                </div>

                <!-- Welcome Message -->
                <div class="bg-green-50 rounded p-4 mb-4 border border-green-200 text-left">
                    <p class="text-green-800 font-medium mb-1">
                        âœ¨ {{ user.status === 'REGISTER' ? 'è¨»å†ŠæˆåŠŸï¼' : 'æ­¡è¿å›ä¾†ï¼' }}
                    </p>
                    <p class="text-sm text-green-600">æ‚¨å·²æˆåŠŸé€šé Line Login é©—è­‰ã€‚</p>
                </div>

                <!-- Admin Note -->
                <div v-if="user.adminNote" class="bg-yellow-50 rounded p-4 mb-4 border border-yellow-200 text-left">
                    <p class="text-yellow-800 font-medium mb-1 flex items-center">
                        <span class="mr-1">ğŸ“</span> ç®¡ç†å“¡å‚™è¨»
                    </p>
                    <p class="text-sm text-yellow-700">{{ user.adminNote }}</p>
                </div>

                <!-- Close Button -->
                <button @click="closeLiff"
                    class="w-full bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-700 transition font-medium">
                    é—œé–‰è¦–çª—
                </button>
            </div>

            <!-- Version Footer -->
            <div class="bg-gray-50 px-4 py-2 text-right">
                <p class="text-xs text-gray-400 font-mono">
                    FE: v1.2.0 | BE: <span id="be-ver">{{ backendVersion }}</span>
                </p>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        const { createApp, ref, onMounted } = Vue;

        // Configuration
        const LIFF_ID = '2008961332-x2ESAmW0';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzK78o86LYKbEBrRWcbo-wvSLizA1dSZfdjuDbGQOw9dsLhND9p-AvQrPs8EKTeiQ/exec';

        createApp({
            setup() {
                const loading = ref(true);
                const error = ref(false);
                const errorMessage = ref('');
                const statusMessage = ref('åˆå§‹åŒ–ä¸­...');
                const user = ref(null);
                const logs = ref([]);
                const backendVersion = ref('-');

                const log = (msg) => {
                    console.log(msg);
                    logs.value.push(msg);
                };

                const closeLiff = () => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        window.close();
                    }
                };

                const retry = () => {
                    window.location.reload();
                };

                // Main Auth Flow
                const initLiff = async () => {
                    try {
                        statusMessage.value = 'LIFF åˆå§‹åŒ–ä¸­...';
                        await liff.init({ liffId: LIFF_ID });

                        if (!liff.isLoggedIn()) {
                            statusMessage.value = 'è«‹ç™»å…¥...';
                            liff.login();
                            return;
                        }

                        statusMessage.value = 'å–å¾—æ¬Šé™ä¸­...';
                        const accessToken = liff.getAccessToken();
                        const profile = await liff.getProfile(); // é›™é‡ç¢ºèªï¼Œå–å¾— profile ç¢ºä¿å·²ç™»å…¥

                        if (!accessToken) throw new Error('ç„¡æ³•å–å¾— Access Token');

                        // Call Backend
                        statusMessage.value = 'é©—è­‰èº«ä»½ä¸­...';
                        await callBackend(accessToken);

                    } catch (err) {
                        console.error(err);
                        error.value = true;
                        errorMessage.value = err.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤';
                    }
                };

                // JSONP Backend Call
                const callBackend = (token) => {
                    return new Promise((resolve, reject) => {
                        const callbackName = 'cb_' + Date.now();

                        // Define Global Callback
                        window[callbackName] = (response) => {
                            // Cleanup
                            delete window[callbackName];
                            document.body.removeChild(script);

                            log('Backend Responded');

                            if (response.version) backendVersion.value = response.version;

                            if (response.success) {
                                user.value = response.data;
                                loading.value = false;
                                resolve(response.data);
                            } else {
                                reject(new Error(response.message || 'å¾Œç«¯é©—è­‰å¤±æ•—'));
                            }
                        };

                        // Create Script
                        const script = document.createElement('script');
                        const url = `${GAS_URL}?access_token=${encodeURIComponent(token)}&callback=${callbackName}`;
                        script.src = url;
                        script.onerror = () => {
                            delete window[callbackName];
                            document.body.removeChild(script);
                            reject(new Error('ç„¡æ³•é€£æ¥ä¼ºæœå™¨ (Script Error)'));
                        };

                        document.body.appendChild(script);
                    });
                };

                onMounted(() => {
                    initLiff();
                });

                return {
                    loading, error, errorMessage, statusMessage,
                    user, logs, backendVersion,
                    closeLiff, retry
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
