<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>LIFF Login Demo</title>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        [v-cloak] {
            display: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <div id="app" class="w-full max-w-md p-4">

        <!-- Loading State -->
        <div v-if="loading" class="bg-white rounded-lg shadow-lg p-8 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-600" v-text="statusMessage"></p>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="bg-white rounded-lg shadow-lg p-8 text-center border-t-4 border-red-500">
            <h3 class="text-xl font-bold text-red-600 mb-2">發生錯誤</h3>
            <p class="text-gray-600 mb-4" v-text="errorMessage"></p>
            <button @click="retry" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">重試</button>
        </div>

        <!-- Success State -->
        <div v-else-if="user" class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-green-500 h-24"></div>
            <div class="px-6 relative">
                <img :src="user.pictureUrl || 'https://via.placeholder.com/150'"
                    class="w-24 h-24 rounded-full border-4 border-white absolute -top-12 shadow-md bg-white">
            </div>
            <div class="mt-16 px-6 pb-6">
                <h2 class="text-2xl font-bold text-gray-800" v-text="user.displayName"></h2>
                <p class="text-sm text-gray-500 mb-4">User ID: <span v-text="user.userId"></span></p>

                <div class="bg-green-50 rounded p-4 mb-4 border border-green-200">
                    <p class="text-green-800 font-medium">✨ <span
                            v-text="user.status === 'REGISTER' ? '註冊成功！' : '歡迎回來！'"></span></p>
                    <p class="text-sm text-green-600">您已成功通過 Line Login 驗證。</p>
                </div>

                <button @click="closeLiff"
                    class="w-full bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-700 transition">
                    關閉視窗
                </button>
            </div>
        </div>

    </div>

    <script>
        // ==================== 配置區 ====================
        // 請修改以下兩個值
        const CONFIG = {
            LIFF_ID: '2008961332-x2ESAmW0',
            GAS_API_URL: 'https://script.google.com/macros/s/AKfycbzK78o86LYKbEbRrWcbo-wvSLizA1dSzfdjuDbGQOw9dsLhND9p-AvQrPs8EKTeiQ/exec'
        };
        // ==============================================

        // Simple reactive system
        const state = {
            loading: true,
            error: false,
            errorMessage: '',
            statusMessage: '初始化中...',
            user: null
        };

        const app = {
            data: state,

            async init() {
                try {
                    console.log('Config:', CONFIG);

                    if (!CONFIG.LIFF_ID || CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
                        throw new Error('請先設定 LIFF_ID');
                    }

                    if (!CONFIG.GAS_API_URL || CONFIG.GAS_API_URL === 'YOUR_GAS_DEPLOYMENT_URL') {
                        throw new Error('請先設定 GAS_API_URL');
                    }

                    this.updateStatus('初始化 LIFF...');
                    await liff.init({ liffId: CONFIG.LIFF_ID });
                    console.log('LIFF initialized');

                    if (!liff.isLoggedIn()) {
                        this.updateStatus('轉導至登入頁面...');
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }

                    this.updateStatus('驗證身分中...');
                    const idToken = liff.getIDToken();
                    console.log('Got ID Token:', idToken ? 'Yes' : 'No');

                    if (!idToken) {
                        throw new Error('無法取得 ID Token');
                    }

                    await this.verifyBackend(idToken);

                } catch (err) {
                    console.error('Error:', err);
                    this.showError(err.message || '初始化失敗');
                }
            },

            async verifyBackend(idToken) {
                try {
                    console.log('Calling API:', CONFIG.GAS_API_URL);

                    // 使用 JSONP 避免 CORS 問題
                    const callbackName = 'liffCallback' + Date.now();
                    const url = `${CONFIG.GAS_API_URL}?id_token=${encodeURIComponent(idToken)}&callback=${callbackName}`;

                    return new Promise((resolve, reject) => {
                        // 設定 timeout
                        const timeout = setTimeout(() => {
                            cleanup();
                            reject(new Error('請求超時'));
                        }, 30000);

                        // 定義 callback 函數
                        window[callbackName] = (data) => {
                            cleanup();
                            console.log('API Response:', data);

                            if (data.success) {
                                state.user = data.data;
                                state.loading = false;
                                this.render();
                                resolve();
                            } else {
                                reject(new Error(data.message || '後端驗證失敗'));
                            }
                        };

                        // 清理函數
                        const cleanup = () => {
                            clearTimeout(timeout);
                            delete window[callbackName];
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        };

                        // 建立 script 標籤
                        const script = document.createElement('script');
                        script.src = url;
                        script.onerror = () => {
                            cleanup();
                            reject(new Error('無法連接伺服器'));
                        };

                        document.head.appendChild(script);
                    });

                } catch (err) {
                    console.error('Backend error:', err);
                    throw new Error('無法連接伺服器: ' + err.message);
                }
            },

            updateStatus(message) {
                state.statusMessage = message;
                this.render();
            },

            showError(message) {
                state.error = true;
                state.errorMessage = message;
                state.loading = false;
                this.render();
            },

            retry() {
                window.location.reload();
            },

            closeLiff() {
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.close();
                    alert('請手動關閉視窗');
                }
            },

            render() {
                const appEl = document.getElementById('app');
                const template = appEl.innerHTML;

                // Simple template rendering
                let html = template;

                // v-if conditions
                if (state.loading) {
                    html = html.replace(/v-else-if="error"[\s\S]*?(?=<div v-else-if|<\/div>\s*<\/div>)/, '');
                    html = html.replace(/v-else-if="user"[\s\S]*$/, '');
                } else if (state.error) {
                    html = html.replace(/v-if="loading"[\s\S]*?(?=<div v-else-if)/, '');
                    html = html.replace(/v-else-if="user"[\s\S]*$/, '');
                } else if (state.user) {
                    html = html.replace(/v-if="loading"[\s\S]*?(?=<div v-else-if)/, '');
                    html = html.replace(/v-else-if="error"[\s\S]*?(?=<div v-else-if)/, '');
                }

                // v-text bindings
                html = html.replace(/v-text="statusMessage"/g, `>${state.statusMessage}<`);
                html = html.replace(/v-text="errorMessage"/g, `>${state.errorMessage}<`);

                if (state.user) {
                    html = html.replace(/v-text="user\.displayName"/g, `>${state.user.displayName}<`);
                    html = html.replace(/v-text="user\.userId"/g, `>${state.user.userId}<`);
                    html = html.replace(/:src="user\.pictureUrl[^"]*"/g, `src="${state.user.pictureUrl}"`);
                    html = html.replace(/v-text="user\.status[^"]*"/g, `>${state.user.status === 'REGISTER' ? '註冊成功！' : '歡迎回來！'}<`);
                }

                appEl.innerHTML = html;

                // Re-attach event listeners
                const retryBtn = appEl.querySelector('[\\@click="retry"]');
                if (retryBtn) retryBtn.onclick = () => this.retry();

                const closeBtn = appEl.querySelector('[\\@click="closeLiff"]');
                if (closeBtn) closeBtn.onclick = () => this.closeLiff();
            }
        };

        // Start app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>

</html>
