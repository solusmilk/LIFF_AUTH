<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>LIFF Login Demo</title>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        [v-cloak] {
            display: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <div id="app" class="w-full max-w-md p-4">

        <!-- Loading State -->
        <div v-if="loading" class="bg-white rounded-lg shadow-lg p-8 flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-600" v-text="statusMessage"></p>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="bg-white rounded-lg shadow-lg p-8 text-center border-t-4 border-red-500">
            <h3 class="text-xl font-bold text-red-600 mb-2">ç™¼ç”ŸéŒ¯èª¤</h3>
            <p class="text-gray-600 mb-4" v-text="errorMessage"></p>
            <button @click="retry" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">é‡è©¦</button>
        </div>

        <!-- Success State -->
        <div v-else-if="user" class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-green-500 h-24"></div>
            <div class="px-6 relative">
                <img :src="user.pictureUrl || 'https://via.placeholder.com/150'"
                    class="w-24 h-24 rounded-full border-4 border-white absolute -top-12 shadow-md bg-white">
            </div>
            <div class="mt-16 px-6 pb-6">
                <h2 class="text-2xl font-bold text-gray-800" v-text="user.displayName"></h2>
                <p class="text-sm text-gray-500 mb-2">User ID: <span v-text="user.userId"></span></p>
                <!-- Debug: Force Show Role -->
                <div class="bg-gray-800 text-white p-2 text-xs rounded mb-4 font-mono overflow-auto text-left">
                    <p>Role: "{{ user.role }}"</p>
                    <p>Status: "{{ user.accountStatus }}"</p>
                </div>

                <!-- è§’è‰²æ¨™ç±¤ (Dynamic Class Binding) -->
                <div class="mb-4 text-center">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-bold shadow-sm" :class="{
                            'bg-purple-100 text-purple-800 border border-purple-200': user.role === 'admin',
                            'bg-blue-100 text-blue-800 border border-blue-200': user.role === 'user',
                            'bg-gray-100 text-gray-800 border border-gray-200': user.role === 'guest' || !user.role
                        }">
                        {{ user.role === 'admin' ? 'ğŸ‘‘ ç®¡ç†å“¡' : (user.role === 'user' ? 'ğŸ‘¤ ä½¿ç”¨è€…' : 'ğŸ‘ï¸ è¨ªå®¢') }}
                    </span>

                    <span v-if="user.accountStatus === 'pending'"
                        class="ml-2 inline-block px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                        â³ å¾…å¯©æ ¸
                    </span>
                </div>

                <div class="bg-green-50 rounded p-4 mb-4 border border-green-200">
                    <p class="text-green-800 font-medium">âœ¨ <span
                            v-text="user.status === 'REGISTER' ? 'è¨»å†ŠæˆåŠŸï¼' : 'æ­¡è¿å›ä¾†ï¼'"></span></p>
                    <p class="text-sm text-green-600">æ‚¨å·²æˆåŠŸé€šé Line Login é©—è­‰ã€‚</p>
                </div>

                <!-- ç®¡ç†å“¡å‚™è¨» -->
                <div v-if="user.adminNote" class="bg-yellow-50 rounded p-4 mb-4 border border-yellow-200">
                    <p class="text-yellow-800 font-medium mb-1">ğŸ“ ç®¡ç†å“¡å‚™è¨»</p>
                    <p class="text-sm text-yellow-700" v-text="user.adminNote"></p>
                </div>

                <button @click="closeLiff"
                    class="w-full bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-700 transition">
                    é—œé–‰è¦–çª—
                </button>
            </div>
        </div>

    </div>

    <!-- ç‰ˆæœ¬è™Ÿé¡¯ç¤º -->
    <div id="version-info"
        style="position: fixed; bottom: 10px; right: 10px; font-size: 11px; color: #999; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 4px; font-family: monospace;">
        Frontend: v1.1.0 | Backend: <span id="backend-version">-</span>
    </div>

    <script>
        // ==================== é…ç½®å€ ====================
        // è«‹ä¿®æ”¹ä»¥ä¸‹å…©å€‹å€¼
        const CONFIG = {
            LIFF_ID: '2008961332-x2ESAmW0',
            GAS_API_URL: 'https://script.google.com/macros/s/AKfycbzK78o86LYKbEbRrWcbo-wvSLizA1dSzfdjuDbGQOw9dsLhND9p-AvQrPs8EKTeiQ/exec'
        };
        // ==============================================

        // Simple reactive system
        const state = {
            loading: true,
            error: false,
            errorMessage: '',
            statusMessage: 'åˆå§‹åŒ–ä¸­...',
            user: null
        };

        const app = {
            data: state,

            async init() {
                try {
                    console.log('Config:', CONFIG);

                    if (!CONFIG.LIFF_ID || CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
                        throw new Error('è«‹å…ˆè¨­å®š LIFF_ID');
                    }

                    if (!CONFIG.GAS_API_URL || CONFIG.GAS_API_URL === 'YOUR_GAS_DEPLOYMENT_URL') {
                        throw new Error('è«‹å…ˆè¨­å®š GAS_API_URL');
                    }

                    this.updateStatus('åˆå§‹åŒ– LIFF...');
                    await liff.init({ liffId: CONFIG.LIFF_ID });
                    console.log('LIFF initialized');

                    if (!liff.isLoggedIn()) {
                        this.updateStatus('è½‰å°è‡³ç™»å…¥é é¢...');
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }

                    this.updateStatus('é©—è­‰èº«åˆ†ä¸­...');

                    // ä½¿ç”¨ LIFF Profile API ç›´æ¥å–å¾—ä½¿ç”¨è€…è³‡æ–™
                    const profile = await liff.getProfile();
                    console.log('Got Profile:', profile);

                    if (!profile) {
                        throw new Error('ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™');
                    }

                    // å–å¾— Access Tokenï¼ˆæœ‰æ•ˆæœŸè¼ƒé•·ï¼‰
                    const accessToken = liff.getAccessToken();
                    console.log('Got Access Token:', accessToken ? 'Yes' : 'No');

                    await this.verifyBackend(profile, accessToken);

                } catch (err) {
                    console.error('Error:', err);
                    this.showError(err.message || 'åˆå§‹åŒ–å¤±æ•—');
                }
            },

            async verifyBackend(profile, accessToken) {
                try {
                    console.log('Calling API:', CONFIG.GAS_API_URL);

                    // ä½¿ç”¨ JSONP é¿å… CORS å•é¡Œ
                    const callbackName = 'liffCallback' + Date.now();
                    const url = `${CONFIG.GAS_API_URL}?user_id=${encodeURIComponent(profile.userId)}&display_name=${encodeURIComponent(profile.displayName)}&picture_url=${encodeURIComponent(profile.pictureUrl)}&access_token=${encodeURIComponent(accessToken)}&callback=${callbackName}`;

                    return new Promise((resolve, reject) => {
                        // è¨­å®š timeout
                        const timeout = setTimeout(() => {
                            cleanup();
                            reject(new Error('è«‹æ±‚è¶…æ™‚'));
                        }, 30000);

                        // å®šç¾© callback å‡½æ•¸
                        window[callbackName] = (data) => {
                            cleanup();
                            console.log('API Response:', data);

                            // æ›´æ–°å¾Œç«¯ç‰ˆæœ¬è™Ÿé¡¯ç¤º
                            if (data.version) {
                                document.getElementById('backend-version').textContent = data.version;
                            }

                            if (data.success) {
                                state.user = data.data;
                                state.loading = false;
                                this.render();
                                resolve();
                            } else {
                                reject(new Error(data.message || 'å¾Œç«¯é©—è­‰å¤±æ•—'));
                            }
                        };

                        // æ¸…ç†å‡½æ•¸
                        const cleanup = () => {
                            clearTimeout(timeout);
                            delete window[callbackName];
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        };

                        // å»ºç«‹ script æ¨™ç±¤
                        const script = document.createElement('script');
                        script.src = url;
                        script.onerror = () => {
                            cleanup();
                            reject(new Error('ç„¡æ³•é€£æ¥ä¼ºæœå™¨'));
                        };

                        document.head.appendChild(script);
                    });

                } catch (err) {
                    console.error('Backend error:', err);
                    throw new Error('ç„¡æ³•é€£æ¥ä¼ºæœå™¨: ' + err.message);
                }
            },

            updateStatus(message) {
                state.statusMessage = message;
                this.render();
            },

            showError(message) {
                state.error = true;
                state.errorMessage = message;
                state.loading = false;
                this.render();
            },

            retry() {
                window.location.reload();
            },

            closeLiff() {
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.close();
                    alert('è«‹æ‰‹å‹•é—œé–‰è¦–çª—');
                }
            },

            render() {
                const appEl = document.getElementById('app');

                // æ¸…ç©ºå…§å®¹
                appEl.innerHTML = '';

                if (state.loading) {
                    // Loading State
                    appEl.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-8 flex flex-col items-center">
                            <div class="loader mb-4"></div>
                            <p class="text-gray-600">${state.statusMessage}</p>
                        </div>
                    `;
                } else if (state.error) {
                    // Error State
                    appEl.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-8 text-center border-t-4 border-red-500">
                            <h3 class="text-xl font-bold text-red-600 mb-2">ç™¼ç”ŸéŒ¯èª¤</h3>
                            <p class="text-gray-600 mb-4">${state.errorMessage}</p>
                            <button id="retryBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">é‡è©¦</button>
                        </div>
                    `;
                    document.getElementById('retryBtn').onclick = () => this.retry();
                } else if (state.user) {
                    // Success State
                    const statusText = state.user.status === 'REGISTER' ? 'è¨»å†ŠæˆåŠŸï¼' : 'æ­¡è¿å›ä¾†ï¼';
                    appEl.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="bg-green-500 h-24"></div>
                            <div class="px-6 relative">
                                <img src="${state.user.pictureUrl || 'https://via.placeholder.com/150'}" 
                                     class="w-24 h-24 rounded-full border-4 border-white absolute -top-12 shadow-md bg-white">
                            </div>
                            <div class="mt-16 px-6 pb-6">
                                <h2 class="text-2xl font-bold text-gray-800">${state.user.displayName}</h2>
                                <p class="text-sm text-gray-500 mb-4">User ID: <span>${state.user.userId}</span></p>
                                
                                <div class="bg-green-50 rounded p-4 mb-4 border border-green-200">
                                    <p class="text-green-800 font-medium">âœ¨ ${statusText}</p>
                                    <p class="text-sm text-green-600">æ‚¨å·²æˆåŠŸé€šé Line Login é©—è­‰ã€‚</p>
                                </div>

                                <button id="closeBtn" class="w-full bg-slate-800 text-white py-3 rounded-lg hover:bg-slate-700 transition">
                                    é—œé–‰è¦–çª—
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('closeBtn').onclick = () => this.closeLiff();
                }
            }
        };

        // Start app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>

</html>
